<section class="page-width" style="max-width: 1100px; margin: 0 auto; padding: 24px;">
  {% assign product = product %}

  <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 28px;">
    <!-- Media -->
    <div>
      {% if product.featured_image %}
        <img
          src="{{ product.featured_image | image_url: width: 900 }}"
          alt="{{ product.featured_image.alt | escape }}"
          loading="lazy"
          style="width:100%; height:auto; border-radius: 12px;"
        >
      {% endif %}
    </div>

    <!-- Info + Form -->
    <div>
      <h1 style="margin:0 0 10px;">{{ product.title }}</h1>

      <p id="Price" style="font-size: 20px; margin: 0 0 18px;">
        {{ product.selected_or_first_available_variant.price | money }}
      </p>

      {% if product.description != blank %}
        <div style="opacity:0.9; line-height:1.5; margin-bottom: 18px;">
          {{ product.description }}
        </div>
      {% endif %}

      {% form 'product', product, id: 'product-form', novalidate: 'novalidate' %}
        <!-- Variant selector -->
        {% unless product.has_only_default_variant %}
          {% for option in product.options_with_values %}
            <div style="margin-bottom: 14px;">
              <label style="display:block; font-weight:600; margin-bottom:6px;">
                {{ option.name }}
              </label>

              <select
                name="options[{{ option.name | escape }}]"
                data-option-index="{{ forloop.index0 }}"
                style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;"
              >
                {% for value in option.values %}
                  <option
                    value="{{ value | escape }}"
                    {% if option.selected_value == value %}selected{% endif %}
                  >
                    {{ value }}
                  </option>
                {% endfor %}
              </select>
            </div>
          {% endfor %}
        {% endunless %}

        <!-- Hidden variant id gets set by JS -->
        <input type="hidden" name="id" id="VariantId" value="{{ product.selected_or_first_available_variant.id }}">

        <!-- Quantity -->
        <div style="display:flex; gap: 12px; align-items:center; margin: 16px 0;">
          <label for="Quantity" style="font-weight:600;">Qty</label>
          <input
            id="Quantity"
            name="quantity"
            type="number"
            min="1"
            value="1"
            style="width:90px; padding:10px; border-radius:10px; border:1px solid #ddd;"
          >
        </div>

        <!-- Add to cart -->
        {% assign v = product.selected_or_first_available_variant %}
        <button
          type="submit"
          id="AddToCart"
          {% unless v.available %}disabled{% endunless %}
          style="width:100%; padding:14px 16px; border:0; border-radius:12px; font-weight:700; cursor:pointer;"
        >
          {% if v.available %}Add to cart{% else %}Sold out{% endif %}
        </button>

        <p id="ATCMessage" style="margin-top: 10px;"></p>

        <!-- Variant JSON for JS -->
        <script type="application/json" id="VariantsJson">
          {{ product.variants | json }}
        </script>
      {% endform %}
    </div>
  </div>
</section>

<script>
(function () {
  const form = document.getElementById('product-form');
  if (!form) return;

  const variants = JSON.parse(document.getElementById('VariantsJson').textContent);
  const optionSelects = form.querySelectorAll('select[name^="options["]');
  const variantIdInput = document.getElementById('VariantId');
  const priceEl = document.getElementById('Price');
  const atcBtn = document.getElementById('AddToCart');
  const msgEl = document.getElementById('ATCMessage');

  function getSelectedOptions() {
    return Array.from(optionSelects).map(s => s.value);
  }

  function findVariantByOptions(selected) {
    return variants.find(v => {
      // Shopify variant.options is array in the same order as product.options
      return v.options.every((opt, idx) => opt === selected[idx]);
    });
  }

  function moneyFormat(cents) {
    // Simple fallback. Your theme might have a better money formatter.
    return (cents / 100).toLocaleString(undefined, { style: 'currency', currency: Shopify.currency.active });
  }

  function updateUI() {
    const selected = getSelectedOptions();
    const variant = findVariantByOptions(selected) || variants[0];

    variantIdInput.value = variant.id;

    if (priceEl && typeof variant.price === 'number') {
      priceEl.textContent = moneyFormat(variant.price);
    }

    if (variant.available) {
      atcBtn.disabled = false;
      atcBtn.textContent = 'Add to cart';
    } else {
      atcBtn.disabled = true;
      atcBtn.textContent = 'Sold out';
    }
  }

  optionSelects.forEach(s => s.addEventListener('change', updateUI));
  updateUI();

  // Optional: show a small message on submit (still uses normal Shopify cart submission)
  form.addEventListener('submit', () => {
    if (msgEl) msgEl.textContent = 'Adding to cart...';
  });
})();
</script>

{% schema %}
{
  "name": "Main product (Custom)",
  "settings": []
}
{% endschema %}